<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4AM Event</title>
<link rel="icon" href="assets/calendar.png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
/* Responsive, professional styles */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280;
  --accent-1:#4f46e5; --accent-2:#06b6d4; --accent-grad: linear-gradient(135deg,var(--accent-1),var(--accent-2));
  --shadow: 0 8px 30px rgba(15,23,42,0.08); --danger:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f172a;-webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;padding-bottom:40px;
}

/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;padding:14px;max-width:1100px;margin:18px auto;
  background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;box-shadow:var(--shadow);
}
.title{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;background:var(--accent-grad);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
button{border:0;background:transparent;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn{background:var(--card);border:1px solid #eef2ff;padding:8px 12px;border-radius:10px;color:var(--accent-1)}
.btn-primary{background:var(--accent-grad);color:#fff;padding:8px 12px;border-radius:10px}
.small{font-size:13px;color:var(--muted)}

/* Calendar */
#calendar{max-width:1100px;margin:18px auto;padding:12px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.weekday{font-size:12px;color:var(--muted);text-align:center}
.day{background:linear-gradient(180deg,#fff,#fbfdff);min-height:110px;padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:8px;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
.day.empty{background:transparent;cursor:default;box-shadow:none}
.date{font-weight:700}
.events{margin-top:auto;display:flex;flex-direction:column;gap:8px}
.eventDot{display:inline-block;padding:6px 8px;border-radius:10px;color:#fff;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));font-size:12px}

/* Admin side panel */
.panel{position:fixed;right:20px;top:110px;width:360px;background:linear-gradient(180deg,#fff,#fbfdff);padding:14px;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,23,0.12);display:none;z-index:40}
.panel.show{display:block}
.form-row{display:flex;flex-direction:column;gap:8px;margin-top:8px}
input[type="text"],textarea,input[type="password"]{width:100%;padding:10px;border-radius:10px;border:1px solid #eef2ff}
textarea{min-height:90px;resize:vertical}

/* Modal backdrop and container */
.modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.45), rgba(2,6,23,0.35));display:none;align-items:center;justify-content:center;z-index:60;}
.modal-backdrop.show{display:flex}
.modal{width:92%;max-width:520px;border-radius:16px;padding:18px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 30px 80px rgba(2,6,23,0.28);border:1px solid rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:12px}

/* Token login layout */
.token-grid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
.token-grid .note{grid-column:1 / -1;color:var(--muted);font-size:13px}
.token-actions{display:flex;gap:8px;justify-content:flex-end}
.token-actions .btn{min-width:88px}
@media (max-width:520px){
  .modal{padding:14px;border-radius:12px}
  .token-grid{grid-template-columns:1fr;gap:10px}
  .token-actions{flex-direction:column-reverse;align-items:stretch}
  .token-actions .btn{width:100%}
}

/* Event details modal */
.event-modal{width:92%;max-width:820px;border-radius:14px;padding:16px;background:#fff;max-height:86vh;overflow:auto}
.event-card{border-radius:12px;padding:14px;margin-bottom:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 12px 30px rgba(2,6,23,0.06)}
.footer-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}

/* Responsive adjustments */
@media(max-width:820px){
  .panel{display:none}
  #calendar{padding:8px;gap:8px}
  .day{min-height:90px;padding:10px}
}
</style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo">EP</div>
    <div>
      <div style="font-weight:700">Event Planner</div>
    </div>
  </div>

  <div class="controls">
    <button id="prev" class="btn">◀</button>
    <div id="monthLabel" class="small"></div>
    <button id="next" class="btn">▶</button>
    <button id="adminBtn" class="btn-primary">Admin Login</button>
  </div>
</header>

<main>
  <div id="calendar"></div>

  <aside id="panel" class="panel" aria-hidden="true">
    <h3 id="dayTitlePanel"></h3>

    <ul id="eventsListPanel"></ul>

    <div id="addSection" class="form-row">
      <input id="eventTitle" type="text" placeholder="Event title" />
      <textarea id="eventDesc" placeholder="Event description (details, location, time, etc.)"></textarea>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="addEvent" class="btn-primary">Add Event</button>
      <button id="closePanel" class="btn">Close</button>
    </div>

    <div style="margin-top:12px">
      <div class="small" id="adminNotice">Only admin can add, edit, or delete events</div>
      <div class="small" style="margin-top:6px">Admin mode: <strong id="adminState">off</strong></div>
      <div class="small" style="margin-top:6px" id="githubStatus">GitHub: not connected (repo fixed)</div>
      <div class="small" style="margin-top:6px;color:var(--muted)">Repo: <strong>page-host/panda-homepage/events.json</strong></div>
    </div>
  </aside>
</main>

<!-- Event details modal -->
<div id="eventModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="event-modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <div id="eventModalDate" style="font-weight:700"></div>
        <div class="small" id="modalSub">Click an event to read details</div>
      </div>
      <div>
        <button id="modalAdd" class="btn-primary">Add (admin)</button>
        <button id="modalClose" class="btn">Close</button>
      </div>
    </div>

    <div id="eventModalList"></div>

    <div class="footer-row">
      <div class="small" id="modalAdminNote"></div>
    </div>
  </div>
</div>

<!-- Token login modal (responsive) -->
<div id="tokenModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="tokenLoginTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h3 id="tokenLoginTitle" style="margin:0">Admin Login — GitHub Token</h3>
        <div class="small" style="margin-top:6px">Paste a GitHub Personal Access Token (session-only). Token needs public_repo or repo scope.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="tokenCancel" class="btn">Cancel</button>
      </div>
    </div>

    <div class="token-grid" style="margin-top:12px">
      <label for="tokenInput" class="small">Personal Access Token</label>
      <input id="tokenInput" type="password" placeholder="ghp_xxx..." autocomplete="one-time-code" />
      <div class="note" style="margin-top:6px">Token is stored in session only and cleared when you close the tab or logout.</div>
      <div class="token-actions" style="margin-top:6px">
        <button id="tokenSubmit" class="btn-primary">Connect</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Configuration
*/
const GITHUB_OWNER = 'page-host';
const GITHUB_REPO  = 'panda-homepage';
const GITHUB_PATH  = 'events.json';
const RAW_BRANCH = 'main';
const COMMITTER_NAME = 'Event Planner';
const COMMITTER_EMAIL = 'noreply@example.com';
/* ===========================
*/

/* Elements */
const monthLabel = document.getElementById('monthLabel'), cal = document.getElementById('calendar');
const panel = document.getElementById('panel'), dayTitlePanel = document.getElementById('dayTitlePanel'), eventsListPanel = document.getElementById('eventsListPanel');
const addSection = document.getElementById('addSection'), eventTitle = document.getElementById('eventTitle'), eventDesc = document.getElementById('eventDesc');
const addEvent = document.getElementById('addEvent'), closePanel = document.getElementById('closePanel');
const prev = document.getElementById('prev'), next = document.getElementById('next'), adminBtn = document.getElementById('adminBtn');
const adminState = document.getElementById('adminState'), adminNotice = document.getElementById('adminNotice'), githubStatus = document.getElementById('githubStatus');

const eventModalBackdrop = document.getElementById('eventModalBackdrop'), eventModalDate = document.getElementById('eventModalDate'), eventModalList = document.getElementById('eventModalList');
const modalClose = document.getElementById('modalClose'), modalAdd = document.getElementById('modalAdd'), modalAdminNote = document.getElementById('modalAdminNote');

const tokenModalBackdrop = document.getElementById('tokenModalBackdrop'), tokenInput = document.getElementById('tokenInput');
const tokenSubmit = document.getElementById('tokenSubmit'), tokenCancel = document.getElementById('tokenCancel');

let adminMode = sessionStorage.getItem('isAdmin') === 'true';
let viewDate = new Date();

/* Token handling */
function setSessionToken(token){
  if(token) sessionStorage.setItem('gh_token_session', token);
  else sessionStorage.removeItem('gh_token_session');
}
function getSessionToken(){ return sessionStorage.getItem('gh_token_session') || ''; }

/* Local events storage helpers */
function saveLocalEvents(events){ localStorage.setItem('events_local', JSON.stringify(events)); }
function loadLocalEvents(){ return JSON.parse(localStorage.getItem('events_local') || '{}'); }

/* fetchEventsFromGitHub: public-first with cache-busting */
async function fetchEventsFromGitHub(token){
  const owner = GITHUB_OWNER, repo = GITHUB_REPO, path = GITHUB_PATH;

  // 1) Try unauthenticated public raw fetch (cache-busted)
  try {
    const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${RAW_BRANCH}/${encodeURIComponent(path)}?t=${Date.now()}`;
    const rawRes = await fetch(rawUrl, { cache: 'no-cache' });
    if (rawRes.ok) {
      const text = await rawRes.text();
      if (text && text.trim()) {
        try {
          const parsed = JSON.parse(text);
          return { json: parsed, sha: null };
        } catch (err) {
          console.warn('Raw JSON parse failed', err);
        }
      }
    } else {
      console.warn('Raw fetch status', rawRes.status);
    }
  } catch (err) {
    console.warn('Public raw fetch error', err);
  }

  // 2) Fallback to authenticated contents API if token provided
  if (!token) return null;
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }});
  if(res.status === 200){
    const j = await res.json();
    const content = atob(j.content.replace(/\n/g,'')); // decode base64
    return { json: JSON.parse(content), sha: j.sha };
  } else {
    console.warn('Authenticated contents API fetch failed', res.status);
    return null;
  }
}

/* pushEventsToGitHub with logging */
async function pushEventsToGitHub(token, eventsObj, currentSha){
  const owner = GITHUB_OWNER, repo = GITHUB_REPO, path = GITHUB_PATH;
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(eventsObj, null, 2))));
  const body = {
    message: currentSha ? `Update events ${new Date().toISOString()}` : `Create events ${new Date().toISOString()}`,
    content: contentBase64,
    committer: { name: COMMITTER_NAME, email: COMMITTER_EMAIL }
  };
  if(currentSha) body.sha = currentSha;
  const res = await fetch(url, {
    method: 'PUT',
    headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' },
    body: JSON.stringify(body)
  });
  console.log('PUT to GitHub status', res.status);
  if(!res.ok){
    const text = await res.text();
    console.error('GitHub PUT error body', text);
    throw new Error(`GitHub API error ${res.status}: ${text}`);
  }
  return await res.json();
}

/* UI rendering */
function renderMonth(d = new Date()){
  cal.innerHTML = '';
  const year = d.getFullYear(), m = d.getMonth();
  monthLabel.textContent = d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
  const daysInMonth = new Date(year, m + 1, 0).getDate();
  const firstDay = new Date(year, m, 1).getDay();
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(w => { const el = document.createElement('div'); el.className = 'weekday'; el.textContent = w; cal.appendChild(el) });
  for(let i=0;i<firstDay;i++){ const e = document.createElement('div'); e.className='day empty'; cal.appendChild(e) }
  const events = loadLocalEvents();
  for(let day=1; day<=daysInMonth; day++){
    const cell = document.createElement('div'); cell.className='day';
    const iso = `${year}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    cell.dataset.date = iso;
    cell.innerHTML = `<div class="date">${day}</div><div class="events"></div>`;
    const evs = events[iso] || [];
    if(evs.length) cell.querySelector('.events').innerHTML = evs.map(e => `<span class="eventDot">${escapeHtml(e.title)}</span>`).join('');
    cell.addEventListener('click', () => onDayClick(iso));
    cal.appendChild(cell);
  }
}

/* Day click behavior */
function onDayClick(date){
  const evs = loadLocalEvents()[date] || [];
  if(evs.length === 0){
    if(adminMode){
      openPanel(date);
    }
    return;
  }
  openEventModal(date);
}

/* Side panel (admin) */
function openPanel(date){
  panel.classList.add('show'); panel.dataset.date = date;
  dayTitlePanel.textContent = new Date(date).toDateString();
  renderEventsPanel();
  updateAddSectionVisibility();
}
function renderEventsPanel(){
  const date = panel.dataset.date; const evs = loadLocalEvents()[date] || [];
  eventsListPanel.innerHTML = '';
  if(evs.length === 0){
    const li = document.createElement('li'); li.innerHTML = `<div class="small">No events for this day.</div>`; eventsListPanel.appendChild(li);
  } else {
    evs.forEach((ev,i) => {
      const li = document.createElement('li');
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ev.title)}</div><div class="eventText">${escapeHtml(ev.description)}</div>`;
      const actions = document.createElement('div'); actions.className = 'event-actions';
      if(adminMode){
        const e = document.createElement('button'); e.textContent = 'Edit'; e.className='btn'; e.onclick = ()=>editEvent(date,i);
        const d = document.createElement('button'); d.textContent = 'Delete'; d.className='btn'; d.onclick = ()=>{ if(confirm('Delete this event?')){ deleteEvent(date,i) } };
        actions.appendChild(e); actions.appendChild(d);
      }
      li.appendChild(left); li.appendChild(actions); eventsListPanel.appendChild(li);
    });
  }
}

/* Event modal */
function openEventModal(date){
  const evs = loadLocalEvents()[date] || [];
  eventModalDate.textContent = new Date(date).toDateString();
  eventModalList.innerHTML = '';
  if(evs.length === 0){
    eventModalList.innerHTML = '<div class="small">No events for this day.</div>';
  } else {
    evs.forEach((ev,i) => {
      const card = document.createElement('div'); card.className = 'event-card';
      const title = document.createElement('div'); title.className = 'title'; title.textContent = ev.title;
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = ev.description || '';
      const actions = document.createElement('div'); actions.className = 'event-actions';
      if(adminMode){
        const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.className='btn'; editBtn.onclick = ()=>{ eventModalBackdrop.classList.remove('show'); editEvent(date,i); };
        const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.className='btn'; delBtn.onclick = ()=>{ if(confirm('Delete this event?')){ deleteEvent(date,i); eventModalBackdrop.classList.remove('show'); } };
        actions.appendChild(editBtn); actions.appendChild(delBtn);
      }
      card.appendChild(title); card.appendChild(desc); card.appendChild(actions);
      eventModalList.appendChild(card);
    });
  }
  modalAdminNote.textContent = adminMode ? 'You are viewing as admin.' : 'Viewing only. Login as admin to modify.';
  modalAdd.style.display = adminMode ? 'inline-block' : 'none';
  eventModalBackdrop.classList.add('show'); eventModalBackdrop.setAttribute('aria-hidden','false');
  eventModalBackdrop.dataset.date = date;
}

/* Add/Edit/Delete (admin) */
addEvent.onclick = async ()=>{
  if(!adminMode) return alert('Only admin can add events');
  const date = panel.dataset.date;
  await addEventToDate(date);
}
modalAdd.onclick = ()=>{
  if(!adminMode) return alert('Only admin can add events');
  const date = eventModalBackdrop.dataset.date;
  openPanel(date);
  eventTitle.focus();
  eventModalBackdrop.classList.remove('show');
}

async function addEventToDate(date){
  const title = eventTitle.value.trim(); const description = eventDesc.value.trim();
  if(!title) return alert('Enter title');
  const all = loadLocalEvents(); all[date] = all[date] || []; all[date].push({title,description});
  saveLocalEvents(all);
  renderMonth(viewDate); renderEventsPanel();
  await tryPushToGitHub(all);
}

function editEvent(date,i){
  if(!adminMode) return alert('Only admin can edit events');
  const all = loadLocalEvents(); const ev = all[date][i];
  const t = prompt('Edit title', ev.title); if(t===null) return;
  const d = prompt('Edit description', ev.description); if(d===null) return;
  all[date][i] = {title: t, description: d}; saveLocalEvents(all); renderMonth(viewDate); renderEventsPanel();
  tryPushToGitHub(all);
}
function deleteEvent(date,i){
  if(!adminMode) return alert('Only admin can delete events');
  const all = loadLocalEvents(); all[date].splice(i,1); if(!all[date].length) delete all[date]; saveLocalEvents(all); renderMonth(viewDate); renderEventsPanel();
  tryPushToGitHub(all);
}

/* Close handlers */
modalClose.onclick = ()=>{ eventModalBackdrop.classList.remove('show'); eventModalBackdrop.setAttribute('aria-hidden','true'); }
closePanel.onclick = ()=>panel.classList.remove('show')

/* Navigation */
prev.onclick = ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderMonth(viewDate) }
next.onclick = ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderMonth(viewDate) }

/* Admin login via token only */
adminBtn.onclick = async ()=>{
  if(adminMode){
    adminMode=false; sessionStorage.removeItem('isAdmin'); adminBtn.textContent='Admin Login'; updateAddSectionVisibility(); renderEventsPanel(); setSessionToken(''); githubStatus.textContent = 'GitHub: not connected (repo fixed)'; return;
  }
  tokenInput.value = '';
  tokenModalBackdrop.classList.add('show'); tokenModalBackdrop.setAttribute('aria-hidden','false');
  tokenInput.focus();
};

tokenCancel.onclick = ()=>{ tokenModalBackdrop.classList.remove('show'); tokenModalBackdrop.setAttribute('aria-hidden','true'); }

tokenSubmit.onclick = async ()=>{
  const token = tokenInput.value.trim();
  if(!token) return alert('Paste a GitHub Personal Access Token (PAT).');
  tokenModalBackdrop.classList.remove('show'); tokenModalBackdrop.setAttribute('aria-hidden','true');
  try{
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}`;
    const repoRes = await fetch(url, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }});
    if(repoRes.status === 200){
      setSessionToken(token);
      adminMode = true; sessionStorage.setItem('isAdmin','true'); adminBtn.textContent='Logout Admin';
      updateAddSectionVisibility();
      githubStatus.textContent = `GitHub: connected (session) to ${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_PATH}`;
      try{
        const res = await fetchEventsFromGitHub(token);
        if(res && res.json){
          saveLocalEvents(res.json);
          if(res.sha) localStorage.setItem('gh_sha', res.sha);
          renderMonth(viewDate);
          alert('Connected and pulled events from GitHub (if file existed).');
        } else {
          alert('Connected. No events file found in repo (will create on first push).');
        }
      }catch(err){
        alert('Connected but pull failed: ' + err.message);
      }
    } else if(repoRes.status === 401 || repoRes.status === 403){
      throw new Error('Token rejected (401/403). Check token scope and validity.');
    } else {
      const txt = await repoRes.text();
      throw new Error(`Unexpected response ${repoRes.status}: ${txt.slice(0,200)}`);
    }
  }catch(err){
    setSessionToken('');
    adminMode = false;
    alert('Token validation failed: ' + err.message);
    githubStatus.textContent = 'GitHub: not connected (repo fixed)';
  }
};

/* Pull helper (public-first) */
async function pullFromGitHubSession(showErrors = false){
  try {
    const publicRes = await fetchEventsFromGitHub(null);
    if (publicRes && publicRes.json) {
      saveLocalEvents(publicRes.json);
      renderMonth(viewDate);
      return true;
    }
  } catch (err) {
    console.warn('Public pull attempt failed', err);
  }

  const token = getSessionToken();
  if(!token){
    if(showErrors) alert('No public events file found and no admin token available.');
    return false;
  }
  try {
    const res = await fetchEventsFromGitHub(token);
    if(res && res.json){
      saveLocalEvents(res.json);
      if(res.sha) localStorage.setItem('gh_sha', res.sha);
      renderMonth(viewDate);
      return true;
    } else {
      if(showErrors) alert('No events file found in repo (will create on first push).');
      return false;
    }
  } catch (err) {
    if(showErrors) alert('Pull failed: ' + err.message);
    throw err;
  }
}

/* tryPushToGitHub: ensure sha present before updating (fixes 422 "sha wasn't supplied") */
async function tryPushToGitHub(eventsObj){
  const token = getSessionToken();
  if(!token){
    githubStatus.textContent = 'GitHub: not connected (no session token)';
    return;
  }
  githubStatus.textContent = 'GitHub: syncing...';
  try{
    // Ensure we have the latest sha before pushing
    let currentSha = localStorage.getItem('gh_sha') || null;

    // If we don't have a sha, try to fetch it from the Contents API (authenticated)
    if(!currentSha){
      try {
        const metaUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(GITHUB_PATH)}`;
        const metaRes = await fetch(metaUrl, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }, cache: 'no-cache' });
        if(metaRes.ok){
          const metaJson = await metaRes.json();
          if(metaJson && metaJson.sha){
            currentSha = metaJson.sha;
            localStorage.setItem('gh_sha', currentSha);
          }
        } else if(metaRes.status === 404){
          // file doesn't exist yet — that's fine, we'll create it (no sha required)
          currentSha = null;
        } else {
          console.warn('Could not fetch file metadata before push', metaRes.status);
        }
      } catch (metaErr) {
        console.warn('Error fetching file metadata before push', metaErr);
      }
    }

    // Now call pushEventsToGitHub with the (possibly null) currentSha
    const res = await pushEventsToGitHub(token, eventsObj, currentSha);

    if(res && res.content && res.content.sha){
      localStorage.setItem('gh_sha', res.content.sha);
      localStorage.setItem('events_last_push', new Date().toISOString());
      console.log('GitHub push response', res);
    }
    githubStatus.textContent = 'GitHub: last sync ' + new Date().toLocaleString();

    // Refresh local copy from remote (public-first)
    try {
      await pullFromGitHubSession(false);
    } catch(e) {
      console.warn('Pull after push failed', e);
    }
  }catch(err){
    githubStatus.textContent = 'GitHub: sync failed';
    console.error('GitHub push failed', err);
    alert('GitHub push failed: ' + err.message);
  }
}

/* Utilities */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) });
}

/* Remote SHA poller: auto-detect remote updates and pull */
async function fetchRemoteSha(token) {
  const owner = GITHUB_OWNER, repo = GITHUB_REPO, path = GITHUB_PATH;
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  try {
    const headers = { Accept: 'application/vnd.github.v3+json' };
    if (token) headers.Authorization = `token ${token}`;
    const res = await fetch(url, { method: 'GET', headers, cache: 'no-cache' });
    if (res.ok) {
      const j = await res.json();
      return j.sha || null;
    } else {
      return null;
    }
  } catch (err) {
    console.warn('fetchRemoteSha error', err);
    return null;
  }
}

let _remotePollRunning = false;
async function remoteShaPoller() {
  if (_remotePollRunning) return;
  _remotePollRunning = true;
  try {
    const token = getSessionToken();
    const remoteSha = await fetchRemoteSha(token);
    const localSha = localStorage.getItem('gh_sha') || null;
    if (remoteSha && remoteSha !== localSha) {
      try {
        await pullFromGitHubSession(false);
        localStorage.setItem('events_last_pull', new Date().toISOString());
      } catch (err) {
        console.warn('Pull after remote SHA change failed', err);
      }
    }
  } finally {
    _remotePollRunning = false;
  }
}

/* Init (public-first) */
(async function init(){
  updateAddSectionVisibility();
  try{
    await pullFromGitHubSession(false);
  }catch(e){
    console.warn('Initial pull failed', e);
  }
  const token = getSessionToken();
  if(token){
    githubStatus.textContent = `GitHub: connected (session) to ${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_PATH}`;
  } else {
    githubStatus.textContent = 'GitHub: not connected (repo fixed)';
  }
  renderMonth(viewDate);
  // start remote poller shortly after init
  setTimeout(remoteShaPoller, 3000);
})();

/* Polling: refresh public copy periodically */
const REMOTE_POLL_INTERVAL_MS = 25000;
setInterval(remoteShaPoller, REMOTE_POLL_INTERVAL_MS);

/* Storage event: refresh when another tab pushes */
window.addEventListener('storage', (e) => {
  if(e.key === 'events_last_push'){
    pullFromGitHubSession().catch(err => console.warn('pull on storage event failed', err));
  }
});

/* Update add form visibility */
function updateAddSectionVisibility(){
  if(adminMode){
    addSection.classList.remove('disabled'); addEvent.classList.remove('disabled'); adminNotice.textContent='You are admin. You can add, edit and delete events.';
    adminState.textContent = 'on';
  } else {
    addSection.classList.add('disabled'); addEvent.classList.add('disabled'); adminNotice.textContent='Only admin can add, edit or delete events.';
    adminState.textContent = 'off';
  }
}
</script>
</body>
</html>


